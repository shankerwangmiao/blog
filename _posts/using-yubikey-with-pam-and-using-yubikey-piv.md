---
title: Yubikey 的花样用法：填时隔半年的坑
date: 2016-08-07 15:39:28
tags: 
- PAM
- 技术
- 折腾
---

突然想起来，我之前说过的要介绍一下 Yubikey 的花样用法的文章。半年来，一直被拖延症给拖延了，就没写成。有一天 [@Blink](https://blog.blink.moe) 提醒我，这还有个大坑要填呢。想起来，半年以来，确实给好多人，比如 [@Youngcow](https://youngcow.net) 老师安利过 Yubikey，还口头介绍过很多次这玩意的用法，看来还是有必要简单地总结一下这个东西的原理和一些花样用法。

## 密码学基础

既然 Yubikey 是密码学设备，那么要想用好这个设备，必然要懂得基本的密码学原理。这节内容仅作为概念解释和科普的作用，不涉及具体的实现方式。

### 古典密码学

古典密码学，研究的是在~~史前~~电子计算机得到广泛应用之前，通过手工计算或简单的机械装置就能完成加解密的一类密码算法。最典型的密码算法，莫过于字母替换了，思路是这样的：

生成一张字母的对应表，如 `A-B B-D C-Z ...` 加密时按这张表格替换，解密时换回来即可。

在这个过程中，我们涉及到了这么几个概念：

* 原文：被加密的文字
* 密文：加密后的文字
* 密码算法：指加密和解密的方法，如这里的“按表格替换”
* 密钥：指的是密码算法的一个参数，如这里的“对应表格”

一般地来说，理想情况下，只有当密钥正确的时候，才能由密文恢复明文（使用解密算法）。并且只要密钥未知，那么从密文恢复明文的唯一方法，就是穷举所有可能的密钥；而由于可能的密钥过多，难以穷举完毕。因此，只要保证密钥的保密性，密文就是安全的。

当然了，稍有经验的人都知道，刚才的“密码算法”，并不符合“理想情况”，因为可以通过统计密文的字母频率等方法，直接推算出密钥，从而破解密文。

### 对称密码算法

然而，现代的密码学研发出的对称密码算法，则在相当大的程度上，可以保证上述的“理想情况”。目前上常用的对称密码学算法有 DES、3DES、AES 等，其中，目前比较安全，且广泛采用的是 AES。

简要概括对称密码算法，就是这样的：

$$密文=加密算法(原文,密钥)$$
$$原文=解密算法(密文,密钥)$$

### 加密模式

现代的对称密码算法，可以用密钥加密一段定长的数据（被称为数据块）。而现实情况下，被加密的数据往往长度不一，甚至有的是数据流，没有确定的长度。因此就会涉及到，怎么针对各种数据应用这些密码算法。

一个很简单的想法是，如果密码算法一次能加密长度为 $b$ 的数据，那就把被加密的数据切割成长度为 $b$ 的小段，分别用同一个密钥 $k$ 进行加密，最后再把得到的密文连接起来，就可以了。解密时，也类似地进行。那么这种办法就是一种“加密模式”，被称之为 ECB。

由于这种加密模式反复使用同一把密钥，被认为降低安全性，因此较不常用。有的加密模式中，会用 $k$ 加密第一段数据；再根据第一段数据的加密结果，将 $k$ 进行变换，变成 $k'$，用于加密第二段数据，这样每一段数据加密时所用的密钥都不相同，提高了安全性。注意，由于加密第二段以及后面数据的密钥是由原始密钥 $k$ 推算出来，所以加密和解密的时候，只需要知道原始的 $k$ 就可以进行了。

在使用类似于 `openssl` 加密数据的时候，可以选择的密码算法都是类似于 `aes-128-cbc`、`aes-256-ecb` 这样的。这里的 `cbc` 和 `ecb` 就是加密模式。

### 哈希算法

哈希算法又称为散列算法。它的输入是任意的，输出是定长的二进制序列。从这一点上来看，必然会出现两组不同的输入产生相同的输出。然而，哈希算法应该有这样的性质：

* 对于给定的输出，没有能行的办法推算输入；
* 对于绝大多数的输入，如果发生改变，则输出也随之发生改变。

常用的哈希算法有 MD5、SHA1、SHA256 等。其中 MD5 已经被视为不安全，SHA1 正在逐步被淘汰，目前 SHA256 和 SHA512 被视为是较为安全的。

### HMAC

HMAC 则是利用了哈希算法，同时引入另外的一个参数 $k$。你可能猜到了，这个 $k$ 是一把密钥。HMAC 与正常的哈希算法的联系和区别是：

* HMAC 是一种基于某种哈希算法的算法，而哈希算法是一类算法；
* 与哈希算法相类似，HMAC 算法的输入（之一）是任意数据，输出是定长的二进制序列；
* 与哈希算法相类似，HMAC 算法亦不能通过输出推定输入，在输入改变时，也会得到不同的输出；
* 与哈希算法不同的是，HMAC 算法的输入还包括了一个密钥 $k$；
* 已知任意多对输入与其输出，不能推算出来密钥 $k$；
* 针对同样的输入，使用不同的密钥 $k$，得到的输出值不同。

HMAC 的算法的大致思路是，对输入进行多次的哈希运算，且运算时将密钥 $k$ 引入，用于对输入以及中间结果进行变换。

正如之前所说，HMAC 是基于一种特定的哈希算法的，因此，你会在很多地方见到 `MD5-HMAC`、`SHA1-HMAC` 之类的写法，这里的 `MD5`、`SHA1` 就是基于的哈希算法。

### 上面的这些东西的应用


